#!/bin/bash
# wpinstaller/config/wp_installer.cfg
# CONFIGURAZIONE CENTRALIZZATA - SICUREZZA E PERMESSI

# 1. RILEVAZIONE AMBIENTE
# --------------------------
WSL_MODE=$(grep -qi "microsoft" /proc/version && echo "true" || echo "false")
MYSQL_SOCKET=$([ "$WSL_MODE" = "true" ] && echo "/run/mysqld/mysqld.sock" || echo "/var/run/mysqld/mysqld.sock")
SERVICE_CMD=$([ "$WSL_MODE" = "true" ] && echo "service" || echo "systemctl")

# 2. CONFIGURAZIONI PRINCIPALI
# --------------------------
DOMAIN="localhost"                    # Dominio del sito
WP_DIR="/var/www/html/wordpress"      # Root di WordPress
SERVER_PORT="80"                      # Porta HTTP
ADMIN_EMAIL="admin@${DOMAIN}"         # Email amministratore
PHP_VERSION="8.3"                     # Versione PHP
ENV_MODE="local"                      # Modalità: local/prod
SSL_TYPE="selfsigned"                 # Tipo SSL: letsencrypt/selfsigned/none
WP_DEBUG="false"                      # Modalità debug WP

# 3. SICUREZZA E PERMESSI
# --------------------------
WP_UID="www-data"                     # Utente PHP/WordPress
WP_GID="www-data"                     # Gruppo PHP/WordPress
MYSQL_CREDS_DIR="/root/.wp_secure"    # Directory credenziali
DIR_PERMS="750"                       # Permessi directory
FILE_PERMS="640"                      # Permessi file

# 4. GESTIONE CREDENZIALI DATABASE
# --------------------------
MYSQL_CREDS_FILE="${MYSQL_CREDS_DIR}/.mysql_creds"

# Crea directory credenziali se non esiste
if [ ! -d "${MYSQL_CREDS_DIR}" ]; then
    mkdir -p "${MYSQL_CREDS_DIR}"
    chmod 700 "${MYSQL_CREDS_DIR}"
fi

# Genera o carica credenziali
if [ ! -f "${MYSQL_CREDS_FILE}" ]; then
    # Genera credenziali complesse
    MYSQL_ROOT_PASS=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*()_+-=' | head -c 32)
    MYSQL_WP_USER="wp_user_$(openssl rand -hex 3)"
    MYSQL_WP_PASS=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*()_+-=' | head -c 32)
    MYSQL_WP_DB="wp_db_$(openssl rand -hex 3)"

    # Salva in modo sicuro
    umask 177
    cat > "${MYSQL_CREDS_FILE}" <<EOF
# NON MODIFICARE MANUALMENTE!
MYSQL_ROOT_PASS='${MYSQL_ROOT_PASS}'
MYSQL_WP_USER='${MYSQL_WP_USER}'
MYSQL_WP_PASS='${MYSQL_WP_PASS}'
MYSQL_WP_DB='${MYSQL_WP_DB}'
EOF
    chmod 400 "${MYSQL_CREDS_FILE}"
fi

# Carica credenziali esistenti
source "${MYSQL_CREDS_FILE}"

# 5. VERIFICA INTEGRITÀ
# --------------------------
if [ -z "${MYSQL_WP_USER}" ] || [ -z "${MYSQL_WP_PASS}" ] || [ -z "${MYSQL_WP_DB}" ]; then
    echo "❌ Errore: Credenziali database non valide!" >&2
    exit 1
fi